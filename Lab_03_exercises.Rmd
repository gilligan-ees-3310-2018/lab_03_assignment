---
title: 'EES 3310/5310 Lab #2'
author: "put your name here"
date: 'Lab: Mon. Sept. 4. Due: Fri. Sept. 8.'
output:
  pdf_document: default
  html_document: default
subtitle: Exercises with the MODTRAN Model
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(inline = function(x) { knitr:::format_sci(x, 'md')})
knitr::opts_chunk$set(echo = TRUE)
```
```{r initialize, include=FALSE}
# This section loads necessary R libraries and sources scripts that define 
# useful functions format_md.
# 
data_dir = "data"
script_dir = "scripts"

library(pacman)
p_load(zoo, xml2, tidyverse, stringr)

theme_set(theme_bw(base_size = 15))

source('scripts/utils.R', chdir = T)
source('scripts/modtran.R', chdir = T)

```
# Instructions

For these exercises, I recommend that you work on them with the interactive
web-based MODTRAN models to get a feel for how the models apply to the 
exercise.

Once you are clear what you are doing, you can use the R scripts and RMarkdown
to turn those insights into reproducible research.

## Using MODTRAN with RMarkdown.

This RMarkdown document includes the line `source("scripts/modtran.R")`,
which loads a script with the following functions:

* `run_modtran()` allows you to automatically download a file
  with the data from a MODTRAN run. You call it with the following arguments:
  
    * `filename` is the name of the file to save the data to. I recommend
      giving it a meaningful name: for instance, a run with 550 ppm CO2 and 3.4
      ppm methane might be called "`modtran_440_34.txt`". Make up your own file
      names, but think about how you will tell which is which.
      
    * `co2_ppm` is the amount of CO~2~ in parts per million. The default is 400.
    
    * `ch4_ppm` is the amount of methane in parts per million. The default is 1.7.
    
    * `trop_o3_ppb` is the amount of ozone in the troposphere, in parts per billion.
      The default is 28. You probably won't change this unless you're setting all
      greenhouse gases to zero.
      
    * `strat_o3_scale` is the amount of stratospheric ozone, relative
      to the naturally occurring levels in the ozone layer. 
      You probably won't change this unless you're setting all
      greenhouse gases to zero.
      
    * `h2o_scale` is the amount of water vapor, relative to the naturally
      occurring levels in the atmosphere. 
      You probably won't change this unless you're setting all
      greenhouse gases to zero.
      
    * `freon_scale` is the amount of freon chemicals (used for refrigerators
      and air conditioners), relative to the current amounts.
      You probably won't change this unless you're setting all
      greenhouse gases to zero.
      
    * `delta_t` is the temperature offset, in degrees C.
      You adjust this to restore radiative equilibrium after you change the
      amount of CO~2~ or other greenhouse gases.
      
    * `h2o_fixed` is what quantity to hold fixed for water vapor.
      Possible values are "vapor pressure" (the default), and "relative humidity"
      
    * `atmosphere` is the locality in the MODTRAN model. 
      Possible values are: "tropical" (the default), 
      "midlatitude summer", "midlatitude winter", 
      "subarctic summer", "subarctic winter", and 
      "standard" for the 1976 U.S. standard atmosphere.
      
    * `clouds` is the specification of clouds and rain.
      Possible values are "none" (the default),
      "cumulus", "altostratus", "stratus", "stratocumulus", "nimbostratus",
      "drizzle", "light rain", "medium rain", "heavy rain", "extreme rain",
      "standard cirrus", "subvisual cirrus", and "NOAA cirrus".
      
        **Stratus clouds** are flat, opaque, and low-altitude. 
        **Altostratus clouds** are flat and medium altitude.
        **Cirrus clouds** are thin and high-altitude. They are hard to model, 
        so there are three different varieties.
        **Cumulus clouds** are thick and stretch from low altitudes to medium altitudes.
        **Stratocumulus clouds** are like thunder clouds. They are very tall and 
        reach from low altitudes to the top of the troposphere.
        **Nimbostratus clouds** are low and thick, like stratus, but produce rain.
        
    * `altitude_km` is the altitude, in kilometers above sea level, that you 
      put your virtual sensor in the model.
      The default is 70 km, which is above almost all of the atmosphere.
      
        For some exercises, you may experiment with putting the sensor somewhere
        around 8 to 12 km, which is the top of the troposphere, below the stratospheric
        ozone layer.
        
        For other exercises, you might want to put it at 0 km (ground level),
        and set it to look up instead of down, so you can see the IR radiation
        coming down to the ground from the atmosphere instead of looking at the 
        IR radiation going out to space.
        
    * `looking` is the direction the sensor is looking. The options are
      "down" (the default) or "up".
      
    Any arguments you don't specify explicitly take on their default value.
    Thus, `run_modtran('data/modtran_experiment_1.txt', co2_ppm = 800, delta_t = 1.0, h2o_fixed = "relative humidity")`
    would run with all the default values, except for 800 ppm CO~2~, 
    a temperature offset of 1&deg;C, and holding relative humidity fixed.

* `plot_modtran` reads a MODTRAN output file and generates a plot.
   There are many arguments, and I won't explain them all here, but
   the important ones are:
   
    * `filename` is the MODTRAN output file with the data to use for the plot.
     
    * `descr` is an optional string to use for the title of the plot.
      If you don't specify anything, the function will make a title
      that indicates the CO2 concentration and the altitude of the virtual
      sensor.
    
    * `i_out_ref` is a reference value for the outgoing infrared. If you don't
      specify it, it's ignored, but if you specify it, then the plotting
      function adds an annotation to indicate the difference in outgoing IR
      between the current run being plotted and the reference value.
      Typically, you'd run a baseline run of MODTRAN with default parameters
      and then use the upward IR flux from that run as `i_out_ref` when you
      change the CO~2~ concentration or other model parameters.
    
    * `delta_t` is the temperature offset for this model run. If you specify it,
      the plotting function adds an annotation to indicate it.
    
    * `text_size` allows you to adjust the size of the text used for axis labels
      and the plot title.

* `read_modtran(filename)` allows you to read in a MODTRAN output file and 
  examine the data. This function returns a list with 7 elements:
  
    * `spectrum` is a data tibble with the spectral information (wavelength `lambda`,
      wavenumber `k`, outgoing IR intensity `tk`, and a number of other variables.)
    
    * `profile` is the profile of the atmosphere: a tibble with three columns:
      `Z` is the altitude in km, 
      `P` is the atmospheric pressure, in millibars, and
      `T` is the temperature in Kelvin.

    * `co2` is the atmospheric CO~2~ concentration
    
    * `ch4` is the atmospheric methane concentration
    
    * `i_out` is the intensity of the outgoing IR radiation flux.
    
    * `alt` is the altitude of the virtual sensor
    
    * `sensor_direction` is the direction of the virtual sensor ("up" or "down").
    
## Examples:

```{r run_modtran_examples, include=TRUE}
run_modtran(filename = "data/modtran_baseline.txt")
run_modtran(filename = "data/modtran_double_co2.txt", co2_ppm = 800)
run_modtran(filename = "data/modtran_double_co2_warming.txt", co2_ppm = 800, delta_t = 0.76)

modtran_baseline = read_modtran('data/modtran_baseline.txt')
baseline_i_out <- modtran_baseline$i_out
```

```{r plot_modtran_examples, include=TRUE}
plot_modtran("data/modtran_baseline.txt")
plot_modtran("data/modtran_double_co2.txt", i_out_ref = baseline_i_out, delta_t = 0)
plot_modtran("data/modtran_double_co2_warming.txt", i_out_ref = baseline_i_out, delta_t = 0.76)
```

# Chapter 4 Exercises

## Exercise 4.1: Methane

Methane has a current concentration of 1.7 ppm in the atmosphere and
is doubling at a faster rate than CO~2~.

> a) Would an additional 10 ppm of methane in the atmosphere have a larger or smaller
>    impact on the outgoing IR flux than an additional 10 ppm of CO~2~ at current
>    concentrations?

> b) Where in the spectrum does methane absorb? What concentration does it take to
>    begin to saturate the absorption in this band? Explain what you are looking 
>    at to judge when the gas is saturated.

> c) Would a doubling of methane have as great an impact on the heat balance as a 
>    doubling of CO~2~?

> d) What is the "equivalent CO~2~" of doubling atmospheric methane? That is to say,
>    how many ppm of CO~2~ would lead to the same change in outgoing IR radiation
>    energy flux as doubling methane? What is the ratio of ppm CO~2~ change to 
>    ppm methane change?


## Exercise 4.2: CO~2~ (Graduate students only)

> a) Is the direct effect of increasing CO~2~ on the energy output at the top of
>    the atmosphere larger in high latitudes or in the tropics?

> b) Set pCO~2~ to an absurdly high value of 10,000 ppm. You will see a spike
>    in the CO~2~ absorption band. What temperature is this light coming from? 
>    Where in the atmosphere do you think this comes from?
>
>      Now turn on clouds and run the model again. Explain what you see.
>      Why are night-time temperatures warmer when there are clouds?

## Exercise 4.3: Water vapor

> Our theory of climate presumes that an increase in the temperature at ground
> level will lead to an increase in the outgoing IR energy flux at the top of the
> atmosphere.


> a) How much extra outgoing IR would you get by raising the temperature of the 
>    ground by 5&deg;C? What effect does the ground temperature have on the 
>    shape of the outgoing IR spectrum and why?

> b) More water can evaporate into warm air than into cool air. Change the
>    model settings to hold the water vapor at constant relative humidity 
>    rather than constant vapor pressure (the default), calculate the change
>    in outgoing IR energy flux for a 5&deg;C temperature increase.
>    Is it higher or lower? Does water vapor make the Earth more sensitive to
>    CO~2~ increases or less sensitive?

> c) Now see this effect in another way. 
>
>       * Starting from the default base case, record the total outgoing 
>         IR flux. 
>
>       * Now double pCO2. The temperature in the model stays the
>         same (that's how the model is written), but the outgoing IR flux
>         goes down.
>
>       * Using constant water vapor pressure, adjust the temperature offset
>         until you get the original IR flux back again. Record the change in
>         temperature
>
>       * Now repeat the exercise, but holding the relative humidity fixed
>         instead of the water vapor pressure.
>
>       * The ratio of the warming when you hold relative humidity fixed
>         to the warming when you hold water vapor pressure fixed is the 
>         feedback factor for water vapor. What is it?
